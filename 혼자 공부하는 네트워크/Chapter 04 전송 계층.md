## 04-1전송 계층 개요: IP의 한계와 포트
- 전송계층은 신뢰할 수 있는 통신과 연결형 통신을 가능하게 하여 이러한 IP의 한계를 극복하고, 포트 번호를 통해 응용 계층의 애플리케이션 프로세스들을 식별하는 역할을 수행
### 신뢰할 수 없는 통신과 비연결형 통신
- IP의 한계라고 볼 수 있는 두 가지 중요한 특징에는 신뢰할 수 없는 프로토콜, 비연결형 프로토콜이라는 점이 있다.
- 신뢰할 수 없는 통신은 IP 프로토콜이 패킷이 수신지까지 제대로 전송되엇다는 보장을 하지 않는 특징
	- 최선형 전달이라고도 부른다.
- 비연결형 통신은 이름 그대로 송수신 호스트 간에 사전 연결 수립 작업을 거치지 않는 특징을 의미한다.
- 이러한 단점의 주요한 이유는 성능 때문을 고려하기 때문에 발생한다.
### IP의 한계를 보완하는 전송 계층
- 전송 계층은 연결형 통신을 가능하게 한다.
	- 연결형 프로토콜인 TCP를 사용
- 전송 계층은 신뢰성 있는 통신을 가능하게 한다.
	- TCP는 패킷이 수신지까지 올바른 순서대로 확실히 전달되는 것을 보장
	- 비교적 높은 성능을 위해 UDP 프로토콜도 사용 가능
		- UDP는 신뢰할 수 없는 통신, 비연결형 통신을 가능하게 하는 전송 계층의 프로토콜
### 응용 계층과의 연결 다리, 포트
- 포트 : 패킷에 특정 애플리케이션을 식별할 수 있는 정보
- 포트 번호를 통해 특정 애플리케이션을 식별
	- 포트 번호는 16비트로 표현 가능, 사용 가능한 포트의 수는 2^16(65536개)
	- 0번부터 1023번까지의 포트 번호는 '잘 알려진 포트'
	- 1024번 부터 49151번까지는 '등록된 포트'
	- 49152번 부터 65535번까지는 동적, 사설, 임시 포트라고 부른다.
### 포트 기반 NAT
- NAT란 IP 주소를 변환하는 기술이며, 사설 IP 주소와 공인 IP 주소를 변환하는 데 사용. 이때 사용 되는 것이 NAT 변환 테이블 이다.
- 오늘날 NAT 기술은 대부분 다수의 사설 IP 주소를 그보다 적은 수의 공인 IP 주소로 변환. 이때 포트를 활용
- 포트 기반의 NAT를 NAPT라 한다.

### 좀 더 알아보기
```
- 포트 포워딩 : 네트워크 내 특정 호스트에 IP 주소와 포트 번호를 미리 할당하고, 해당 IP 주소:포트 번호로써 해당 호스트에게 패킷을 전달하는 기능
- ICMP : 패킷의 전송 과정에 대한 피드백 메시지를 얻기 위해 사용하는 프로토콜, IP의 신뢰할 수 없는 전송 특성과 비연결형 전송 특성을 보완하기 위한 네트워크 계층의 프로토콜
```

## 04-2 TCP와 UDP
- TCP는 신뢰할 수 있는 통신을 위한 연결형 프로토콜
- UDP는 TCP보다 신뢰성은 떨어지지만 비교적 빠른 통신이 가능한 비연결형 프로토콜
### TCP 통신 단계와 세그먼트 구조
- TCP의 통신의 세 단계
	- 연결 수립 -> 데이터 송수신 -> 연결 종료
- MSS(Maximum Segment Size)는 TCP로 전송할 수 있는 최대 페이로드 크기. 헤더 크기는 제외
- 송신지 포트와 수신지 포트 : 송신지 또는 수신지 애플리케이션을 식별하는 포트 번호가 명시되는 필드
- 순서 번호 : 순서 번호가 명시되는 필드
- 확인 응답 번호 : 다음으로 수신하기를 기대하는 순서 번호가 명시되는 필드
- 제어 비트 : 세그먼트에 대한 부가 정보를 나타낸다.
- 윈도우 : 수신 윈도우의 크기가 명시(한 번에 수신하고자 하는 데이터의 양)

**제어 비트**
- 기본적으로 8비트로 구성
- ACK : 세그먼트의 승인을 나타내기 위한 비트
- SYN : 연결을 수립하기 위한 비트
- FIN : 연결을 종료하기 위한 비트

**순서 번호와 확인 응답 번호**
- 신뢰성을 보장하기 위해 사용되는 중요한 필드
- 순서 번호는 올바른 송수신 순서를 보장하기 위한 번호
- 초기 순서 번호는 무작위 값, 이후 순서 번호는 `초기 순서 번호 + 송신한 바이트 수`
- 확인 응답 번호는 수신자가 다음으로 받기를 기대하는 순서 번호 `수신한 순서 번호 + 1`

### TCP 연결 수립과 종료

**연결 수립**
- 세 개의 단계로 이루어진 쓰리 웨이 핸드셰이크 연결 수립 과정이 이루어진다.
- 액티브 오픈 -> 패시브 오픈

**연결 종료**
- 액티브 클로즈 -> 패시브 클로즈
### TCP 상태
- 연결형 통신과 신뢰할 수 있는 통신을 유지하기 위해 '상태'를 유지
- TCP는 상태를 유지하고 활용한다는 점에서 스테이트풀 프로토콜이라고 한다.

**연결이 수립되지 않은 상태**
- CLOSED : 아무런 연결이 없는 상태
- LISTEN : 일종의 연결 대기 상태

**연결 수립 상태**
- SYN-SENT : 연결 요청을 보낸 뒤 대기하는 상태
- SYN-RECEIVED : 패시브 오픈 호스트가 ACK 세그먼트를 기다리는 상태
- ESTABLISHED : 연결이 확립되었음을 나타내는 상태

**연결 종료 상태**
- FIN-WAIT-1 : FIN 세그먼트로서 연결 종료 요청을 보낸 액티브 클로즈 호스트의 상태
- CLOSE-WAIT : 종료 요청인 FIN 세그먼트를 받은 패시브 클로즈 호스트가 ACK 세그먼트를 보낸 후 대기하는 상태
- FIN-WAIT-2 : 1 상태에서 ACK 세그먼트를 받은 상태
- LAST-ACK : CLOSE-WAIT 상태에서 FIN 세그먼트를 전송한 뒤 이에 대한 ACK 세그먼트를 기다리는 상태
- TIME-WAIT : 마지막 ACK 세그먼트를 전송한 뒤 접어드는 상태. 일정 시간을 기다린 뒤 CLOSED 상태로 전이
	- 마지막 ACK 세그먼트가 올바르게 전송되지 않을 수 있기 때문에 일정 시간을 대기
### UDP 데이터그램 구조
- 비연결형 통신을 수행하는 신뢰할 수 없는 프로토콜
- 스테이트리스 프로토콜의 일종
- 송신지 포트와 수신지 포트 : 송수신지의 포트 번호
- 길이 : 헤더를 포함한 UDP 데이터그램의 바이트
- 체크섬 : 오류가 발생했는지 검사하기 위한 필드

## 04-3 TCP의 오류, 흐름, 혼잡 제어
- TCP는 재선송을 기반으로 다양한 오류를 제어하고, 흐름 제어를 통해 처리할 수 있을 만큼의 데이터만을 주고받으며, 혼잡 제어를 통해 네트워크가 혼잡한 정도에 따라 전송량을 조절한다.
### 오류 제어: 재전송 기법
- TCP는 잘못된 세그먼트를 재전송하는 방법을 사용(재전송 기반 오류 제어)

**오류 검출과 재전송**
- 체크섬은 세그먼트의 훼손 여부만 나타낼 뿐
- TCP가 오류를 검출하고 세그먼트를 재전송하는 상황
	- 중복된 ACK 중복된 세그먼트를 수신했을 때
	- 타임아웃이 발생했을 때

**ARQ: 재전송 기법**
- 수신 호스트의 답변과 타임아웃 발생을 토대로 문제를 진단하고, 문제가 생긴 메시지를 재전송함으로써 신뢰성을 확보하는 방식
- Stop-and-Wait ARQ
	- 제대로 전달했음을 확인하기 전까지는 새로운 메시지를 보내지 않는 방식
- Go-Back-N ARQ
	- 파이프라이닝을 활용(연속해서 메시지를 전송할 수 있는 기술)
	- 도중에 잘못 전송된 세그먼트가 발생할 경우 해당 세그먼트부터 전부 다시 전송하는 방식
	- 누적 확인 응답
- Selective Repeat ARQ
	- 선택적으로 재전송하는 방법
	- 개별 확인 응답
	- 오늘날 TCP는 Selective Repeat ARQ 우선, 지원하지 않을 경우 Go-Back-N ARQ 사용
### 흐름 제어: 슬라이딩 윈도우
- 호스트가 한 번에 받아서 처리할 수 있는 세그먼트 양만큼 송신해야 한다.
- 수신 버퍼 : 수신된 세그먼트가 임시로 저장되는 공간
- 버퍼 오버플로 : 버퍼가 넘치는 상황
- 흐름 제어란 송수신 속도를 균일하게 유지하는 것을 의미
- 윈도우란 송신 호스트가 파이프라이닝할 수 있는 최대량을 의미
- 수신 측에서 설정한 윈도우 크기만큼 송신 측에서 확인 응답 없이 세그먼트를 전송할 수 있게 하여 데이터 흐름을 동적으로 조절하는 제어 기법

### 혼잡 제어
- 많은 트래픽으로 인해 패킷의 처리 속도가 늦어지거나 유실될 우려가 있는 네트워크 상황을 혼잡이라 하며, 이러한 혼잡을 제어하기 위한 기능을 혼잡 제어라고 한다.
- 혼잡 제어의 주체는 송신 호스트
- 혼잡 없이 전송할 수 있을 법한 데이터양을 혼잡 윈도우라고 한다.
- 혼잡 윈도우 크기는 혼잡 제어 알고리즘을 통해 결정할 수 있다.
	- AIMD(Additive Increase/Multiplicative Decrease) : 혼잡이 감지되지 않는다면 혼잡 윈도우를 RTT마다 1씩 선형적으로 증가시키고, 혼잡이 감지되면 혼잡 윈도우를 절반으로 떨어뜨리는 동작을 반복하는 알고리즘
	- 느린 시작 : 혼잡 윈도우를 1부터 시작해 문제없이 수신된 ACK 세그먼트 하나당 1씩 증가시키는 방식
	- 혼잡 회피 : RTT마다 혼잡 윈도우를 1MSS씩 증가시키는 알고리즘. 느린 시작 임계치를 넘어선 시점부터 혼잡 윈도우를 증가시키는 방식
	- 빠른 회복 : 세 번의 중복 ACK 세그먼트를 수신했을 때 느린 시작은 건너뛰고 혼잡 회피를 수행하는 알고리즘