## 1단계 문제 이해 및 설계 범위 확정
### 요구사항
- 빠른 응답 속도 : 100밀리초 이내
- 연관성
- 정렬: 인기도 등의 순위 모델에 의해 정렬
- 규모 확장성
- 고가용성

### 개략적 규모 추정
- DAU 천만 명
- 평균적으로 한 사용자는 매일 10건의 검색
- 질의할 때마다 평균적으로 20바이트의 데이터를 입력
	- 평균적으로 4개의 단어, 다섯 글자로 구성
	- 질의당 평균 4 * 5 = 20바이트
- 평균적으로 1회 검색당 20건의 요청이 백엔드로 전달
- 대략 초당 24,000건의 질의 발생
- 최대 QPS 48,000
- 질의 가운데 20% 정도는 신규 검색어

## 2단계 개략적 설계안 제시 및 동의 구하기
- 데이터 수집 서비스 : 사용자가 입력한 질의를 실시간으로 수집하는 시스템
- 질의 서비스 : 인기 검색어를 정렬해 내놓는 서비스

### 데이터 수집 서비스
- 질의문과 사용빈도를 저장하는 빈도 테이블 사용

### 질의 서비스
- 자동완성 검색어가 빈도 테이블에 기록된 수치를 사용해 계산
- 데이터가 아주 많아지면 데이터베이스가 병목

## 3단계 상세 설계
- 트라이 자료구조
- 데이터 수집 서비스
- 질의 서비스

### 트라이 자료구조
- 관계형 데이터베이스를 이용해 가장 인기 있었던 다섯 개 질의문을 골라내는 방안은 비효율.
- 트라이를 사용해 해결
- 트라이는 문자열들을 간략하게 저장할 수 있는 자료구조
- 문자열을 꺼내는 연산에 초점을 맞추어 설계된 자료구조
	- 트리 형태의 자료구조
	- 트리의 루트 노드는 빈 문자열을 나타낸다
	- 각 노드는 글자 하나를 저장
	- 각 트리 노드는 하나의 단어, 또는 접두어 문자열을 나타냄
- 노드에 인기 검색어 캐시
	- 각 노드에 k개의 인기 검색어를 저장해 두면 전체 트라이를 검색하는 일을 방지

### 데이터 수집 서비스
- 사용자가 검색창에 뭔가 타이핑을 할 때마다 실시간으로 데이터를 수정하는 방법은 실용적이지 못하다.
- 데이터 분석 서비스 로그
	- 질의에 관한 원본 데이터를 보관
- 로그 취합 서버
	- 데이터 취합 방식은 우리 서비스의 용례에 따라 달라질 수 있다.
	- 일주일 주기로 취합한다는 가정
- 취합된 데이터
	- time, frequency 필드 사용하여 취합
- 작업 서버
	- 트라이 자료구조를 만들고 트라이 데이터베이스에 저장하는 역할
- 트라이 캐시
	- 트라이 데이터를 메모리에 유지
- 트라이 데이터베이스
	- 트라이 데이터베이스로 사용할 수 있는 선택지
		- 문서 저장소
		- 키-값 저장소

### 질의 서비스
- 캐시미스는 캐시 서버의 메모리가 부족하거나 캐시 서버에 장애가 있어도 발생 가능
- 최적화 하기 위해 비동기로 요청하거나, 브라우저 캐싱을 사용

### 트라이 연산
- 트라이는 검색어 자동완성 시스템의 핵심 컴포넌트
- 트라이 생성은 작업 서버가 담당
- 트라이 갱신은 매주 한 번 갱신하거나, 트라이의 각 노드를 개별적으로 갱신하는 방법이 있다.
- 검색어 삭제를 위한 좋은 방법은 트라이 캐시 앞에 필터 계층을 두고 부적절한 질의어가 반환되지 않도록 하는 것이다.

### 저장소 규모 확장
- 첫 글자를 기준으로 샤딩
	- 데이터를 각 서버에 균등하게 배분하기 불가능
	- 검색어 대응 샤드 관리자를 사용

## 4단계 마무리
- 실시간 검색어 자동완성 시스템 구축시 고려 사항
	- 샤딩을 통하여 작업 대상 데이터의 양 축소
	- 순위 모델 변경
	- 스트림 프로세싱