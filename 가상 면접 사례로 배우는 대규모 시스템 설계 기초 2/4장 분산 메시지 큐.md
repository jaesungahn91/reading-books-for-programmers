- 메시지 큐 장점
	- 결합도 완화
	- 규모 확장성 개선
	- 가용성 개선
	- 성능 개선
## 1단계: 문제 이해 및 설계 범위 확정
### 기능 요구사항
- 생산자는 메시지 큐에 메시지를 보낼 수 있어야 한다.
- 소비자는 메시지 큐를 통해 메시지를 수신할 수 있어야 한다.
- 메시지는 반복적으로 수신할 수도 있어야하고, 단 한 번ㅇ만 수신하도록 설정 될 수도 있어야 한다.
- 오래된 이력 데이터는 삭제될 수 있다.
- 메시지 크기는 킬로바이트 수준이다.
- 메시지가 생상된 순서대로 소비자에게 전달할 수 있어야 한다.
- 메시지 전달 방식은 최소 한 번, 최대 한 번, 정확히 한 번 가운데 설정할 수 있어야 한다.
### 비기능 요구사항
- 높은 대역폭과 낮은 전송 지연 가운데 하나를 설정으로 선택 가능하게 하는 기능
- 규모 확장성. 이 시스템은 특성상 분산 시스템일 수밖에 없다. 메시지 양이 급증해도 처리 가능해야 한다.
- 지속성 및 내구성. 데이터는 디스크에 지속적으로 보관되어야 하며 여러 노드에 복제되어야 한다.

## 2단계: 개략적 설계안 제시 및 동의 구하기
### 클라이언트
- 생산자
- 소비자 그룹
### 핵심 서비스 및 저장소
- 브로커
- 저장소
	- 데이터 저장소
	- 상태 저장소: 소비자 상태
	- 메타데이터 저장소
- 조정 서비스
	- 서비스 탐색
	- 리더 선출
	- 아파치 주키퍼

## 3단계: 상세 설계
### 데이터 저장소
- 쓰기 우선 로그(WAL) 사용
- 접근 패턴이 순차적일때 아주 좋은 성능
### 일괄 처리
- 생산자, 소비자, 메시지 큐는 메시지를 가급적 일괄 처리
### 생산자 측 작업 흐름
- 라우팅 계층 도입
	- 라우팅 계층은 '적절한' 브로커에 메시지를 보내는 역할을 담당
- 라우팅 계층을 생산자 내부로 편입시키고 버퍼 도입
### 소비자 측 작업 흐름
- 풀 모델 사용
	- 일괄 처리에 적합
	- 컴퓨팅 자원 낭비
		- 롱 폴링 모드
### 소비자 재조정
- 소비자가 어떤 파티션을 책임지는지 다시 정하는 프로세스
- 코디네이터는 소비자 재조정을 위해 소비자들과 통신하는 브로커 노드
### 주키퍼
- 메타데이터와 상태 저장소는 주키퍼를 이용해 구현
- 클러스터의 리더 선출 과정을 돕는다.
- 브로커는 메시지 데이터 저장소만 유지
### 복제
- 높은 가용성을 보장
- 리더 브로커 노드가 사본 분산 계획을 만들고 메타데이터 저장소에 보관
### 사본 동기화
- 동기화된 사본(ISR)은 리더와 동기화된 사본을 일컫는 용어
- ISR은 성능과 영속성 사이의 타협점
### 규모 확장성
- 생산자
	- 간단
- 소비자
	- 소비자 그룹은 독립적임. 쉽게 추가 삭제 가능
	- 재조정이 필요
- 브로커
	- 데이터를 사본과 같은 노드에 두면 안됨
	- 브로커 노드가 추가되거나 삭제될 때 사본을 재배치
	- 브로커 컨트롤로 하여금 한시적으로 시스템에 설정된 사본 수보다 많은 사본을 허용
### 메시지 전달 방식
- 최대 한번 : 소실될 수 있음
- 최소 한번 : 메시지 소실 X
- 정확히 한 번 : 구현하기 어려움
### 고급 기능
- 메시지 필터링 : 브로커에서 메시지를 필터링. 메타데이터를 사용하는 것이 효율적
- 메시지의 지연 전송 및 예약 전송
	- 임시 저장소에 넣어 두었다가 시간이 되면 토픽으로 옮김
	- 메시지 지연 전송 전용 메시지 큐를 사용하는 방안과 계층적 타이밍 휠을 사용하는 방안이 있다.