## 7-1 안정성 및 이중화
### 7.1.1 안정성이란?
- 안정성, 고가용성이란, 시스템 서비스가 가능한 한 멈추지 않도록 하는 것

### 7.1.2 이중화란?
- 하나의 기능을 병렬로 여러 개 나열해서 하나의 장애가 발생해도 다른 것을 이용해서 서비스를 계속할 수 있는 것
- 확장성이나 부하분산 같은 성능에 대한 의미도 가진다.
- 이중화 구조
	- 부하분산
	- 내부적 생존 감시
	- 마스터 결정
	- 페일오버

## 7.2 서버 내 이중화
### 7.2.1 전원, 장치 등의 이중화
- 서버 내부 컴포터넌트에서는 전원, 팬 등이 이중화
- 대규모 데이터 센터에서는 각 전원 탭이 별도 분전반이나 UPS에 접속돼 있어서 전원 장애에 대비

### 7.2.2 네트워크 인터페이스 이중화
- PCI 슬롯에 꽂은 카드도 이중화가 가능
	- 여러개의 카드에 복수의 포트가 탑재
- 네트워크 인터페이스를 여러 개로 이중화
	- 하드웨어 또는 OS로 구현
	- 일반적으로 액티브-스탠바이 구성
- 스탠바이가 액티브로 교체하는 것을 페일오버라고 한다.

## 7.3 저장소 이중화
### 7.3.1 HDD 이중화
- 예전에는 서버 저장소를 파이버 채널(PC)로 연결하고 SAN(Storage Area Network)이라는 네트워크를 구죽하는 방법이 유행
	- 높은 비용과 변경에 시간이 걸린다는 단점
- 요즘에는 TCP/IP 프로토콜상에 저장소 네트워크를 구축하는 방식이 늘고 있다.

**저장소 내부 구조와 RAID**
- SAN에서는 IP 주소 대신에 WWN(World Wide Name)이라는 주소를 이용해서 데이터를 전송
- HDD 간을 연결하는 내부 버스에는 다양한 규격이 있지만 SAS(Serial Attached SCSI)가 유명
- RAID는 여러 HDD를 묶어서 그룹으로 만들고 이것을 논리적인 HDD로 인식하는 기술
	- 논리적 HDD를 LU(Local Unit)라고 한다.
- RAID의 장점
	- 안정성 확보
	- 성능 향상
	- 용량 확장
		- I/O를 분할해서 복수의 HDD에 대해 병렬로 I/O 처리, 이 고정 길이를 RAID의 스트라이프크기 라고 한다.

**RAID 구성 패턴**
- RAID5는 이중화 확보를 위해 패리티라는 오류 수정 부호를 기록, 패리티를 분산
- RAID1은 일반적으로 OS 디스크 이중화에 사용
- RAID10은 RAID0과 RAID1을 조합한 구성이다.
	- RAID10은 복수의 HDD에 병렬로 이중 기록
	- 안정성과 성능
- RAID0은 이중화 없이 HDD에 기록하는 방식
- RAID5에서는 패리티 연산이 이루어지기 때문에 I/O 성능이 RAID10에 비해 느리다.
- RAID10은 미러링을 하기 때문에 HDD 전체 용량의 1/2 용량밖에 사용할 수 없다.

**장애 발생 시**
- 이중화 회복을 위해 핫 스페어라고 하는 디스크를 이용
- RAID를 이용해서 이중화를 하더라도 장애 시에 복구할 수 없는 경우가 있기 때문에 데이터 백업도 반드시 해야한다.

### 7.3.2 버스 이중화
- Red Hat Enterprise Linux에는 DM-Multipath라는 버스 이중화 기능이 있다
- DM-Multipath는 I/O 요청을 HBA에 할당해서 페일오버를 실현

## 7.4 웹 서버 이중화
### 7.4.1 웹 서버의 서버 내 이중화
- 아파치에서는 프로세스/스레드를 여러 개를 가동시켜 두어서 클라이언트 요청에 빠르게 대응 할 수 있는 구성을 가지고 있다.

**장애 발생 시**
- 웹 서버에 대한 요청은 큐에 쌓이지 않고 바로 에러를 반환한다는 특징이 있음

### 7.4.2 서버 이중화
- DNS를 이용해서 하나의 호스트명에 대해 복수의 IP 주소를 반환
- DNS 라운드 로빈 기법
	- 호스트명에 대해 복수의 IP주소를 등록해 두는 것으로서 서버 이중화 기법 중 하나다.
	- DNS가 서버 상태를 감시해서 파악하지 않기 때문에 서버가 정지된 경우에도 그 서버의 주소를 반환
	- 세션 상태를 파악하지 않기 때문에 다음 접속 시에 동일 서버에 접속해야 하는 경우에도 부적합

**부하분산 장치를 이용한 웹 서버 이중화**
- 조금 더 고도화한 이중화 방식 : 부하분산 장치(로드 밸런서)
- 세션 유지를 위한 방법
	- 부하분산 장치가 이전에 어느 웹 서버에 요청을 할당했는지 쿠키에 저장
- 부하분산 장치는 임시 대응 관리표로 세션 테이블이라는 것을 만듦
- 부하분산 장치의 첫 접속 시 서버 할당 알고리즘
	- 라운드 로빈 : 서버의 IP 주소에 순서대로 요청 할당
	- 최소 연결 : 현재 활성 세션 수보다 세션 수가 가장 적은 서버의 IP주소에 요청을 할당
	- 응답 시간 : CPU 사용률이나 응답 시간 등을 고려해서 요청 할당

**장애 발생 시**
- 부하분산 장치는 웹 서버의 가동 상태 감시 가능(페일오버 가능)
- 동적 콘텐츠라면 페일오버와 세션 정보가 사라지기 때문에 세션 상태가 초기화
	- 세션 정보를 유지하기 위해서는 페일오버 이외의 다른 구조가 필요

## 7.5 AP 서버 이중화
### 7.5.1 서버 이중화
- 웹 서버와 같이 부하분산 장치를 이용
- 세션 정보 이중화
	- 세션 정보란, 애플리케이션의 상태를 가리킨다.
	- 세션 정보는 접속된 AP 서버를 기본으로 하고 보조 세션을 복사해 둔다

### 7.5.2 DB 연결 이중화
- 연결 풀링(Connection Pooling) 사용
- 연결 풀링의 일반적인 설계 방침
	- 최솟값과 최댓값을 동일하게 설정 : 오버헤드를 초기 가동 시에만 집중시기는 컷
	- 방화벽 유무 확인 : 중간에 방화벽이 있다면 사용ㅇ되지 않은 세션을 자동으로 제거하는 경우도 있기 때문

## 7.6 DB 서버 이중화
### 7.6.1 서버 이중화(액티브-스탠바이)
- DB 서버 이중화 방법으로 수년 전부터 액티브-스탠바이형의 클러스터 구성이 주류
- 서버가 정상 동작하는지 확인하기 위한 구조로 '하트비트'나 '투표 장치' 같은 기능이 존재
- 클러스터 소프트웨어는 등록된 서비스가 정상 동작하고 있는지 정기적으로 확인
- 하트비트를 통해 상태를 인식할 수 없게 되면, 클러스터 소프트웨어는 페일오버 실시 여부를 판단 할 수 없게 된다 = 스플릿 브레인
- 클러스터 소프트웨어는 데이터 일관성을 중시하는 서비스/시스템에 적합

### 7.6.2 서버 이중화(액티브-액티브)
- 쉐어드 에브리씽형
	- 디스크, 데이터를 모든 노드가 공유
	- 장애가 발생해도 다른 노드로 쉽게 처리
	- 데이터 경합을 하기 때문에 처리 속도가 저하
- 쉐어드 낫씽형
	- 각 노드별로 디스크를 가지고 있어서 데이터가 분산된다.
	- 노드를 배치하기 쉽다
	- 갱신 시에 데이터 분산 위치를 검토하기 때문에 전반적인 갱신 처리가 느려지는 경향
- 클라우드상에 구현할 때문, 쉐어드 낫씽형이 압도적으로 많다.

**캐시 전송**
- 쉐어드 에브리씽형의 중요 구조인 캐시 전송
- RAC는 캐시의 데이터를 네트워크 경유로 받아서 디스크 액세스를 줄이고 데이터 취득을 고속화
	- 이것을 RAC에서는 캐시 퓨전이라고 함

## 7.7 네트워크 장비 이중화
### 7.7.1 L2 스위치 이중화
- 스위치를 크로스 케이블 등으로 연결하면 서로 다른 스위치간 통신이 가능
	- 이것을 캐스케이드라고 한다.
- 복수의 네트워크에 연결하는 경우 -> 이런 경우 스위치가 복수의 VLAN을 설정 

**트렁크 포트 이용 시에 필요한 대책**
- 여러 포트를 합쳐서 하나의 이더넷 포트로 이용 = 링크 집합

### 7.7.2 L3 스위치 이중화
- 웹 시스템에서는 게이트웨이가 다운되면 시스템 서비스가 거의 모두 정기되기때문에 L3 스위치 이중화가 매우 중요
- L3 스위치의 액티브-스탠바이를 실현하는 프로토콜 : Virtual Router Redundancy Protocol(VRRP)

### 7.7.3 네트워크 토폴리지
- 복수의 경로가 존재하는 네트워크 구성 = 루프
- 경로가 다수 존재하면 안정성 측면에서 좋지 않다. 
	- 이 모순을 해결하기 위한 수단 = 스패닝 트리 프로토콜(STP)
- STP를 이용하면 논리적으로 포트를 절단할 수 있다.
- STP의 단점은 장애 발생 시 정지 시간이 길다
- RSTP는 STP 개선판, 페일오버 시간이 거의 제로에 가깝다.

## 7.8 사이트 이중화
### 7.8.2 사이트 간 이중화
- 재해에 대한 대책으로 원격지 데이터 센터와 연결하는 기술이 있다.
	- 글로벌 서버 부하분산이라는 구조
- 원격지 데이터 전송 기술을 통틀어서 '재해 복구'라고 부르는 경우도 있다.

## 7.9 감시
### 7.9.1 감시란?
- 시스템 컴포터는가 정상 동작하는지 확인하는 것
- 감시에는 대표적으로 다음과 것이 있다.
	- 생존 감시
	- 로그 감시
	- 성능 감시

### 7.9.2 생존 감시
- ping을 이용한 생존 감시(ping 감시)
	- ping 명령을 정기적으로 실행해서 서버 인터페이스에 대한 통신을 확인하는 감시
- 프로세스 생존 감시
	- OS의 ps 명령어를 이용해서 확인

### 7.9.3 로그 감시
- 로그 감시 프로세스는 중요하다고 인지하고 있는 로그 출력문을 미리 저장해 두고 있다가 실제 로그 파일이 출력되는 내용을 저장해 둔 것과 비교 -> 일치하는 내용이 있으면 문제의 중요도에 맞추어 감시 서버에게 보고
- 통지 밥버은 syslog, SNMP, 메일 등 몇 가지가 있다.

### 7.9.4 성능 감시
- 디스크 사용률, 메모리 사용 현황, 디스크 고갈 등의 리소스 상태 파악과 네트워크 액세스 지연, 디스크 액세스 시간 등의 응답 상태를 파악하는 것

### 3.9.5 SNMP
- 통합 감시 툴
	- JPI, 티볼리, Zabbix, Nagios
- 감시 전용 프로토콜 = SNMP
- 감시 내용
	- 네트워크 장비나 서버 가동 상태
	- 서비스 가동 상태
	- 시스템 리소스(시스템 성능)
	- 네트워크 트래픽
- SNMP는 네트워크 장비와 서버를 일괄 감시해서 관리
- 주요 특징으로 MIB(관리 정보 기반)이라는 것이 있다.
	- MIB는 감시 정의 모델이다.

### 7.9.6 콘텐츠 감시
- 웹 화면이 정상적으로 보여지는지 확인하기 위한 웹 시스템 특유의 감시다.
- 일반적으로는 콘텐츠 감시는 부하분산 장치가 담당
	- HTTP의 GET 요청을 해서 정상적으로 응답이 있는지 확인 = 헬스 체크

## 백업
### 7.10.1 백업이란?
- 이중화와 크데